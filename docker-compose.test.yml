# Test infrastructure for manually testing Edictflow as a user
# Usage:
#   task test:infra:up     # Start the infrastructure
#   task test:infra:shell  # Shell into the user container
#   task test:infra:down   # Stop and cleanup
#
# Auto-connected Agents:
#   5 agent clients (agent1-5) auto-connect on stack up
#   Credentials: agent1@test.local / Test1234 (through agent5@test.local)
#
# Manual Testing:
#   docker exec -it edictflow-test-user-1 bash  # Shell into user simulation container

services:
  # Redis for pub/sub
  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - edictflow-test

  # PostgreSQL database
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: edictflow
      POSTGRES_PASSWORD: edictflow
      POSTGRES_DB: edictflow
    volumes:
      - test_postgres_data:/var/lib/postgresql/data
    ports:
      - "15432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U edictflow"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - edictflow-test

  # Edictflow Master (API server)
  master:
    build:
      context: .
      dockerfile: tests/infrastructure/Dockerfile.master-test
    environment:
      DATABASE_URL: postgres://edictflow:edictflow@db:5432/edictflow?sslmode=disable
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET: test-secret-for-local-testing-only
    ports:
      - "18080:8080"
    volumes:
      - ./tests/infrastructure/seed-data.sql:/seed-data.sql:ro
      - ./tests/infrastructure/master-entrypoint.sh:/entrypoint.sh:ro
    entrypoint: ["/bin/sh", "/entrypoint.sh"]
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - edictflow-test

  # Edictflow Worker (WebSocket server)
  worker:
    build:
      context: .
      dockerfile: server/Dockerfile
      target: worker
    environment:
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET: test-secret-for-local-testing-only
      WORKER_PORT: "8081"
    ports:
      - "18081:8081"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - edictflow-test

  # Web UI
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:18080
        NEXT_PUBLIC_WS_URL: ws://localhost:18081
        NEXT_PUBLIC_WORKER_URL: http://localhost:18081
    environment:
      API_URL: http://master:8080
    ports:
      - "13000:3000"
    depends_on:
      - master
    networks:
      - edictflow-test

  # User simulation container - shell into this to act as a user
  user:
    build:
      context: .
      dockerfile: tests/infrastructure/Dockerfile.user
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
    volumes:
      - user_workspace:/home/developer/workspace
      - user_agent_data:/home/developer/.config/edictflow
    depends_on:
      master:
        condition: service_healthy
    stdin_open: true
    tty: true
    networks:
      - edictflow-test

  # ============================================
  # Auto-connected Agent Clients (1-5)
  # ============================================
  # These agents automatically login and connect on stack startup.
  # They appear as "Connected Agents" in the dashboard.

  agent1:
    build:
      context: .
      dockerfile: agent/Dockerfile
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
      AGENT_EMAIL: agent1@test.local
      AGENT_PASSWORD: Test1234
      POLL_INTERVAL: 500ms
    volumes:
      - ./tests/infrastructure/agent-entrypoint.sh:/entrypoint.sh:ro
      - agent1_data:/home/agent/.edictflow
      - agent1_projects:/home/agent/projects
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    depends_on:
      master:
        condition: service_healthy
    restart: on-failure
    networks:
      - edictflow-test

  agent2:
    build:
      context: .
      dockerfile: agent/Dockerfile
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
      AGENT_EMAIL: agent2@test.local
      AGENT_PASSWORD: Test1234
      POLL_INTERVAL: 500ms
    volumes:
      - ./tests/infrastructure/agent-entrypoint.sh:/entrypoint.sh:ro
      - agent2_data:/home/agent/.edictflow
      - agent2_projects:/home/agent/projects
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    depends_on:
      master:
        condition: service_healthy
    restart: on-failure
    networks:
      - edictflow-test

  agent3:
    build:
      context: .
      dockerfile: agent/Dockerfile
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
      AGENT_EMAIL: agent3@test.local
      AGENT_PASSWORD: Test1234
      POLL_INTERVAL: 500ms
    volumes:
      - ./tests/infrastructure/agent-entrypoint.sh:/entrypoint.sh:ro
      - agent3_data:/home/agent/.edictflow
      - agent3_projects:/home/agent/projects
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    depends_on:
      master:
        condition: service_healthy
    restart: on-failure
    networks:
      - edictflow-test

  agent4:
    build:
      context: .
      dockerfile: agent/Dockerfile
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
      AGENT_EMAIL: agent4@test.local
      AGENT_PASSWORD: Test1234
      POLL_INTERVAL: 500ms
    volumes:
      - ./tests/infrastructure/agent-entrypoint.sh:/entrypoint.sh:ro
      - agent4_data:/home/agent/.edictflow
      - agent4_projects:/home/agent/projects
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    depends_on:
      master:
        condition: service_healthy
    restart: on-failure
    networks:
      - edictflow-test

  agent5:
    build:
      context: .
      dockerfile: agent/Dockerfile
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
      AGENT_EMAIL: agent5@test.local
      AGENT_PASSWORD: Test1234
      POLL_INTERVAL: 500ms
    volumes:
      - ./tests/infrastructure/agent-entrypoint.sh:/entrypoint.sh:ro
      - agent5_data:/home/agent/.edictflow
      - agent5_projects:/home/agent/projects
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    depends_on:
      master:
        condition: service_healthy
    restart: on-failure
    networks:
      - edictflow-test

volumes:
  test_postgres_data:
  user_workspace:
  user_agent_data:
  agent1_data:
  agent1_projects:
  agent2_data:
  agent2_projects:
  agent3_data:
  agent3_projects:
  agent4_data:
  agent4_projects:
  agent5_data:
  agent5_projects:

networks:
  edictflow-test:
    driver: bridge

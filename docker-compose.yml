# EdictFlow Docker Compose Configuration
#
# Profiles:
#   default (no profile)  - Core services only: db, redis, master, worker, web
#   splunk               - Add Splunk observability: docker compose --profile splunk up -d
#   test                 - Add test agents and user container: docker compose --profile test up -d
#   full                 - All services: docker compose --profile splunk --profile test up -d
#   legacy               - Include legacy server: docker compose --profile legacy up -d
#
# Quick Start:
#   make setup           - Clean setup with fresh database
#   docker compose up -d - Start core services (preserves data)
#
# Test Accounts (Password: Password123):
#   - admin@example.com (Admin)
#   - user@example.com (Member)
#   - designer@example.com (Member)
#
# Ports:
#   - Web UI:     http://localhost:3000
#   - Master API: http://localhost:8080
#   - Worker WS:  ws://localhost:8081
#   - Database:   localhost:5432
#   - Redis:      localhost:6380
#   - Splunk UI:  http://localhost:8001 (splunk profile)

services:
  # ============================================
  # Core Services (always started)
  # ============================================

  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT:-6380}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - edictflow

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: edictflow
      POSTGRES_PASSWORD: edictflow
      POSTGRES_DB: edictflow
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U edictflow"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - edictflow

  master:
    build:
      context: .
      dockerfile: server/Dockerfile
      target: master
    ports:
      - "${API_PORT:-8080}:8080"
    environment:
      DATABASE_URL: postgres://edictflow:edictflow@db:5432/edictflow?sslmode=disable
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      SPLUNK_ENABLED: ${SPLUNK_ENABLED:-false}
      SPLUNK_HEC_URL: ${SPLUNK_HEC_URL:-http://splunk:8088/services/collector/event}
      SPLUNK_HEC_TOKEN: ${SPLUNK_HEC_TOKEN:-edictflow-hec-token}
      SPLUNK_SOURCE: ${SPLUNK_SOURCE:-edictflow-master}
      SPLUNK_SOURCETYPE: ${SPLUNK_SOURCETYPE:-edictflow:metrics}
      SPLUNK_INDEX: ${SPLUNK_INDEX:-edictflow}
      SPLUNK_SKIP_TLS_VERIFY: ${SPLUNK_SKIP_TLS_VERIFY:-true}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - edictflow

  worker:
    build:
      context: .
      dockerfile: server/Dockerfile
      target: worker
    ports:
      - "${WORKER_PORT:-8081}:8081"
    environment:
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      WORKER_PORT: "8081"
      SPLUNK_ENABLED: ${SPLUNK_ENABLED:-false}
      SPLUNK_HEC_URL: ${SPLUNK_HEC_URL:-http://splunk:8088/services/collector/event}
      SPLUNK_HEC_TOKEN: ${SPLUNK_HEC_TOKEN:-edictflow-hec-token}
      SPLUNK_SOURCE: ${SPLUNK_SOURCE:-edictflow-worker}
      SPLUNK_SOURCETYPE: ${SPLUNK_SOURCETYPE:-edictflow:metrics}
      SPLUNK_INDEX: ${SPLUNK_INDEX:-edictflow}
      SPLUNK_SKIP_TLS_VERIFY: ${SPLUNK_SKIP_TLS_VERIFY:-true}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - edictflow

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    ports:
      - "${WEB_PORT:-3000}:3000"
    environment:
      API_URL: http://master:8080
      NEXT_PUBLIC_API_URL: http://127.0.0.1:${API_PORT:-8080}
      NEXT_PUBLIC_WS_URL: ws://127.0.0.1:${WORKER_PORT:-8081}
      NEXT_PUBLIC_APPDYNAMICS_ENABLED: ${NEXT_PUBLIC_APPDYNAMICS_ENABLED:-false}
      NEXT_PUBLIC_APPDYNAMICS_APP_KEY: ${NEXT_PUBLIC_APPDYNAMICS_APP_KEY:-}
      NEXT_PUBLIC_APPDYNAMICS_ADR_URL: ${NEXT_PUBLIC_APPDYNAMICS_ADR_URL:-}
      NEXT_PUBLIC_APPDYNAMICS_BEACON_URL: ${NEXT_PUBLIC_APPDYNAMICS_BEACON_URL:-}
    depends_on:
      - master
      - worker
    networks:
      - edictflow

  # ============================================
  # Legacy Server (profile: legacy)
  # ============================================

  server:
    build:
      context: .
      dockerfile: server/Dockerfile
      target: server
    ports:
      - "${LEGACY_SERVER_PORT:-8082}:8080"
    environment:
      DATABASE_URL: postgres://edictflow:edictflow@db:5432/edictflow?sslmode=disable
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    profiles:
      - legacy
    networks:
      - edictflow

  # ============================================
  # Splunk Observability (profile: splunk)
  # ============================================
  # Access: http://localhost:8001
  # Credentials: admin / DevPassword123!
  # HEC Token: edictflow-hec-token

  splunk:
    image: splunk/splunk:latest
    platform: linux/amd64
    container_name: edictflow-splunk
    hostname: splunk
    environment:
      SPLUNK_START_ARGS: --accept-license
      SPLUNK_GENERAL_TERMS: --accept-sgt-current-at-splunk-com
      SPLUNK_PASSWORD: DevPassword123!
      SPLUNK_HEC_TOKEN: edictflow-hec-token
      SPLUNK_APPS_URL: ""
    ports:
      - "8001:8000"   # Splunk Web UI
      - "8088:8088"   # HTTP Event Collector
      - "8089:8089"   # Splunk REST API
    volumes:
      - splunkdata:/opt/splunk/var
      - ./docker/splunk/default.yml:/tmp/defaults/default.yml:ro
      - ./docker/splunk/apps/edictflow:/opt/splunk/etc/apps/edictflow
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 300s
    profiles:
      - splunk
    networks:
      - edictflow

  # ============================================
  # Test Infrastructure (profile: test)
  # ============================================
  # User simulation container - shell in for manual testing
  # Agents: alex.rivera@test.local, jordan.kim@test.local, sarah.chen@test.local,
  #         mike.johnson@test.local, emma.wilson@test.local (Password: Test1234)

  user:
    build:
      context: .
      dockerfile: tests/infrastructure/Dockerfile.user
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
    volumes:
      - user_workspace:/home/developer/workspace
      - user_agent_data:/home/developer/.config/edictflow
    depends_on:
      master:
        condition: service_healthy
    stdin_open: true
    tty: true
    profiles:
      - test
    networks:
      - edictflow

  agent1:
    build:
      context: .
      dockerfile: agent/Dockerfile
    image: edictflow-agent:local
    depends_on:
      master:
        condition: service_healthy
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
      AGENT_EMAIL: alex.rivera@test.local
      AGENT_PASSWORD: Test1234
      POLL_INTERVAL: 500ms
    volumes:
      - ./tests/infrastructure/agent-entrypoint.sh:/entrypoint.sh:ro
      - agent1_data:/home/agent/.edictflow
      - agent1_projects:/home/agent/projects
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    restart: on-failure
    profiles:
      - test
    networks:
      - edictflow

  agent2:
    image: edictflow-agent:local
    depends_on:
      agent1:
        condition: service_started
      master:
        condition: service_healthy
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
      AGENT_EMAIL: jordan.kim@test.local
      AGENT_PASSWORD: Test1234
      POLL_INTERVAL: 500ms
    volumes:
      - ./tests/infrastructure/agent-entrypoint.sh:/entrypoint.sh:ro
      - agent2_data:/home/agent/.edictflow
      - agent2_projects:/home/agent/projects
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    restart: on-failure
    profiles:
      - test
    networks:
      - edictflow

  agent3:
    image: edictflow-agent:local
    depends_on:
      agent1:
        condition: service_started
      master:
        condition: service_healthy
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
      AGENT_EMAIL: sarah.chen@test.local
      AGENT_PASSWORD: Test1234
      POLL_INTERVAL: 500ms
    volumes:
      - ./tests/infrastructure/agent-entrypoint.sh:/entrypoint.sh:ro
      - agent3_data:/home/agent/.edictflow
      - agent3_projects:/home/agent/projects
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    restart: on-failure
    profiles:
      - test
    networks:
      - edictflow

  agent4:
    image: edictflow-agent:local
    depends_on:
      agent1:
        condition: service_started
      master:
        condition: service_healthy
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
      AGENT_EMAIL: mike.johnson@test.local
      AGENT_PASSWORD: Test1234
      POLL_INTERVAL: 500ms
    volumes:
      - ./tests/infrastructure/agent-entrypoint.sh:/entrypoint.sh:ro
      - agent4_data:/home/agent/.edictflow
      - agent4_projects:/home/agent/projects
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    restart: on-failure
    profiles:
      - test
    networks:
      - edictflow

  agent5:
    image: edictflow-agent:local
    depends_on:
      agent1:
        condition: service_started
      master:
        condition: service_healthy
    environment:
      EDICTFLOW_SERVER: http://worker:8081
      EDICTFLOW_API_SERVER: http://master:8080
      AGENT_EMAIL: emma.wilson@test.local
      AGENT_PASSWORD: Test1234
      POLL_INTERVAL: 500ms
    volumes:
      - ./tests/infrastructure/agent-entrypoint.sh:/entrypoint.sh:ro
      - agent5_data:/home/agent/.edictflow
      - agent5_projects:/home/agent/projects
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    restart: on-failure
    profiles:
      - test
    networks:
      - edictflow

volumes:
  pgdata:
  splunkdata:
  user_workspace:
  user_agent_data:
  agent1_data:
  agent1_projects:
  agent2_data:
  agent2_projects:
  agent3_data:
  agent3_projects:
  agent4_data:
  agent4_projects:
  agent5_data:
  agent5_projects:

networks:
  edictflow:
    driver: bridge
